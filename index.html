<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>IA Configurador de PC</title>
  <link rel="stylesheet" href="style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
  <!-- Pantalla de login -->
  <div id="login-screen">
    <div class="login-container">
      <div class="login-content">
        <img src="https://api.dicebear.com/7.x/bottts/svg?seed=robot" class="login-logo" alt="Logo">
        <h1>Configurador de PC con IA</h1>
        <p>Escribe tu nombre y email para empezar</p>
        <form id="manual-login-form" autocomplete="off" style="display:flex;flex-direction:column;gap:12px;">
          <input id="user-name-input" name="name" type="text" placeholder="Tu nombre" maxlength="32" required autocomplete="off">
          <input id="user-email-input" name="email" type="email" placeholder="Tu email" maxlength="60" required autocomplete="off">
          <button type="submit" class="login-button">
            <img src="https://replit.com/public/images/logo-small.png" alt="Entrar" width="20">
            Entrar
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- App principal (s칩lo cuando est치 logueado) -->
  <div id="main-app" style="display: none;">
    <header>
      <div class="header-content">
        <img src="https://api.dicebear.com/7.x/bottts/svg?seed=robot" class="header-logo" alt="Logo">
        <h1 class="app-title">Configurador de PC con IA</h1>
        <div class="user-info">
          <img id="user-avatar" class="user-avatar" alt="Usuario">
          <span id="user-name">Usuario</span>
          <button onclick="logout()" class="logout-btn">Cerrar sesi칩n</button>
        </div>
      </div>
    </header>
    <main>
      <div class="monitor-outer">
        <div class="monitor-inner">
          <!-- Barra de progreso arriba -->
          <div class="progress-indicator">
            <div class="progress-bar-bg">
              <div class="progress-bar-fill" style="width: 40%;"></div>
            </div>
            <div class="progress-steps">
              <span class="progress-step active">Presupuesto</span>
              <span class="progress-step">Pregunta 2</span>
              <span class="progress-step">Pregunta 3</span>
              <span class="progress-step">Pregunta 4</span>
              <span class="progress-step">Pregunta 5</span>
            </div>
            <div class="progress-label">
              <span>Precisi칩n de la recomendaci칩n: <b>40%</b></span>
            </div>
          </div>
          <!-- Chatbox real -->
          <div id="chat-container">
            <div id="chat-log"></div>
            <form id="chat-form" autocomplete="off" style="display:flex; gap:8px;">
              <input type="text" id="chat-input" placeholder="Escribe tu mensaje...">
              <button type="button" id="mic-button" title="Hablar">游꿗</button>
              <button type="submit">Enviar</button>
            </form>
          </div>
        </div>
        <div class="monitor-base"></div>
      </div>
      <!-- Contenedores de configuraci칩n y fotos -->
      <div id="config-container"></div>
      <div id="fotos-container"></div>

      
    </main>
    <footer>
      <div class="footer-content">
        <span>Creado en Replit 췅 2025</span>
      </div>
    </footer>
  </div>

  <script>
    // URL de tu webhook n8n
    const N8N_API_URL = "https://mauriciomeseguer.up.railway.app/webhook/bf351844-0718-4d84-bd9c-e5fbea35a83b";

    // ---- VARIABLES GLOBALES ----
    let currentUser = null;
    let chatId = null;

    const manualLoginForm = document.getElementById('manual-login-form');
    const userNameInput = document.getElementById('user-name-input');
    const userEmailInput = document.getElementById('user-email-input');

    // --- LIMPIEZA Y VALIDACI칍N ---
    function cleanText(text) {
      return text.replace(/[^a-zA-Z0-9치칠칤칩칰츼칄칈칍칔칲칖침칌@.\-_\s]/g, '').trim();
    }
    function isValidEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    manualLoginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      let name = cleanText(userNameInput.value);
      let email = cleanText(userEmailInput.value).toLowerCase();

      if (name.length < 2 || name.length > 32) {
        alert('Pon un nombre v치lido (2-32 caracteres).');
        return;
      }
      if (!isValidEmail(email) || email.length > 60) {
        alert('Pon un email v치lido (hasta 60 caracteres).');
        return;
      }

      currentUser = {
        id: email,
        name: name,
        email: email,
        profileImage: ''
      };
      chatId = generateChatId();

      showMainApp();
      updateUserUI();

      // --- Env칤a SOLO nombre y chatId a n8n tras login ---
      fetch(N8N_API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          user_name: currentUser.name,
          chat_id: chatId
        })
      });
    });

    // --- Generar ID 칰nico de chat ---
    function generateChatId() {
      return `${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    }

    // --- Mostrar pantalla de login ---
    function showLoginScreen() {
      document.getElementById('login-screen').style.display = 'flex';
      document.getElementById('main-app').style.display = 'none';
      manualLoginForm.reset();
    }

    // --- Mostrar app principal ---
    function showMainApp() {
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('main-app').style.display = 'block';
    }

    // --- Actualizar UI del usuario ---
    function updateUserUI() {
      if (currentUser) {
        document.getElementById('user-avatar').src =
          `https://api.dicebear.com/7.x/personas/svg?seed=${encodeURIComponent(currentUser.name)}`;
        document.getElementById('user-name').textContent = currentUser.name || 'Usuario';
      }
    }

    // --- Cerrar sesi칩n ---
    function logout() {
      currentUser = null;
      chatId = null;
      showLoginScreen();
    }

    // --- Inicializar la aplicaci칩n ---
    document.addEventListener('DOMContentLoaded', showLoginScreen);
  </script>
  <!-- VAPI SDK -->
  <script src="https://unpkg.com/@vapi-ai/web@latest/dist/index.js"></script>
</body>
</html>